/*
LaskaKit ESP32-C3 LPkit v3.2
SHT 40
LiPol
Data na TMEP.cz
WiFiManager
Deep Sleep 30 minut
USB CDC onboot = enabled
*/

#include <WiFi.h>
#include <esp_wifi.h>
#include <HTTPClient.h>
#include <SPI.h>
#include <Wire.h>
#include <WiFiManager.h>
#include "Adafruit_SHT4x.h"

#define ADCBpin 0
#define bDeviderRatio 1.7693877551

// Deep sleep na 30 minut v mikrosekundÃ¡ch
#define SLEEP_TIME 30ULL * 60ULL * 1000000ULL  // 30 minut

static Adafruit_SHT4x sht4 = Adafruit_SHT4x();

String serverName = "http://jknmw4-wp8n5a.tmep.cz/index.php?";

void setup() {
  Serial.begin(115200);
  delay(100);
  
  Serial.println("\n--- Start mÄ›Å™enÃ­ ---");
  
  // I2C sbÄ›rnice pro Äidlo teploty a vlhkosti
  Wire.begin(8, 10);
  delay(50);
  
  // Inicializace SHT40 s kontrolou
  if (!sht4.begin()) {
    Serial.println("âŒ SHT40 senzor nenalezen!");
    goToSleep();
    return;
  }
  
  Serial.println("âœ“ SHT40 senzor inicializovÃ¡n");
  sht4.setPrecision(SHT4X_HIGH_PRECISION); // vysokÃ¡ pÅ™esnost mÄ›Å™enÃ­
  sht4.setHeater(SHT4X_NO_HEATER); // bez internÃ­ho ohÅ™Ã­vaÄe

  // WiFiManager s timeoutem
  WiFiManager wifiManager;
  wifiManager.setConfigPortalTimeout(180); // 3 minuty timeout
  
  Serial.println("PÅ™ipojovÃ¡nÃ­ k WiFi...");
  
  // AutomatickÃ© pÅ™ipojenÃ­ nebo konfiguraÄnÃ­ portÃ¡l
  if (!wifiManager.autoConnect("ESP32-LPkit-Config")) {
    Serial.println("âŒ Selhalo pÅ™ipojenÃ­ WiFi - restart");
    delay(1000);
    ESP.restart();
  }

  Serial.println("âœ“ PÅ™ipojeno k WiFi");
  Serial.print("IP adresa: ");
  Serial.println(WiFi.localIP());
  Serial.print("RSSI: ");
  Serial.print(WiFi.RSSI());
  Serial.println(" dBm");

  // MÄ›Å™enÃ­ a odeslÃ¡nÃ­ dat
  measureAndSend();
  
  // PÅ™echod do deep sleep
  goToSleep();
}

void loop() {
  // Loop se nikdy nespustÃ­ kvÅ¯li deep sleep
}

void measureAndSend() {
  /* MÄšÅ˜ENÃ NAPÄšTÃ AKUMULÃTORU */
  float bat_voltage = analogReadMilliVolts(ADCBpin) * bDeviderRatio / 1000.0;
  Serial.print("NapÄ›tÃ­ akumulÃ¡toru: ");
  Serial.print(bat_voltage, 2);
  Serial.println(" V");
  
  // Kontrola kritickÃ©ho napÄ›tÃ­
  if (bat_voltage < 3.0) {
    Serial.println("âš ï¸ VAROVÃNÃ: NÃ­zkÃ© napÄ›tÃ­ baterie!");
  }
  /*--------------------------*/

  /* MÄšÅ˜ENÃ SÃLY WiFi */
  int rssi = WiFi.RSSI();
  Serial.print("WiFi signÃ¡l: ");
  Serial.print(rssi);
  Serial.println(" dBm");
  /*------------------*/

  /* ÄŒIDLO TEPLOTY A VLHKOSTI */
  sensors_event_t humidity, temp;
  
  uint32_t timestamp = millis();
  sht4.getEvent(&humidity, &temp); // ÄekÃ¡nÃ­ na aktuÃ¡lnÃ­ data
  
  float temperature = temp.temperature;
  float humidityValue = humidity.relative_humidity;
  
  Serial.print("Teplota: ");
  Serial.print(temperature, 1);
  Serial.println(" Â°C");
  Serial.print("Vlhkost: ");
  Serial.print(humidityValue, 1);
  Serial.println(" % rH");
  Serial.print("ÄŒas mÄ›Å™enÃ­: ");
  Serial.print(millis() - timestamp);
  Serial.println(" ms");
  /*--------------------------*/

  /* ODESLÃNÃ DAT NA TMEP.cz */
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    
    // SestavenÃ­ URL s parametry
    String serverPath = serverName + 
                       "teplota=" + String(temperature, 2) + 
                       "&vlhkost=" + String(humidityValue, 2) + 
                       "&v=" + String(bat_voltage, 2) + 
                       "&rssi=" + String(rssi);
    
    Serial.println("OdesÃ­lÃ¡m data:");
    Serial.println(serverPath);
    
    // ZaÄÃ¡tek HTTP spojenÃ­
    http.begin(serverPath.c_str());
    http.setTimeout(10000); // 10 sekund timeout
    
    // HTTP GET request
    int httpResponseCode = http.GET();
    
    if (httpResponseCode > 0) {
      Serial.print("âœ“ HTTP Response code: ");
      Serial.println(httpResponseCode);
      String payload = http.getString();
      Serial.println(payload);
    } else {
      Serial.print("âŒ Error code: ");
      Serial.println(httpResponseCode);
      Serial.println(http.errorToString(httpResponseCode));
    }
    
    // UvolnÄ›nÃ­ zdrojÅ¯
    http.end();
  } else {
    Serial.println("âŒ WiFi odpojeno");
  }
  /*----------------------------*/
  
  delay(100); // KrÃ¡tkÃ¡ pauza pÅ™ed spanÃ­m
}

void goToSleep() {
  Serial.println("\nğŸ’¤ PÅ™echod do deep sleep na 30 minut");
  Serial.flush(); // PoÄkej na dokonÄenÃ­ sÃ©riovÃ© komunikace
  
  // OdpojenÃ­ WiFi pro Ãºsporu energie
  WiFi.disconnect(true);
  WiFi.mode(WIFI_OFF);
  
  // NastavenÃ­ deep sleep na 30 minut
  esp_sleep_enable_timer_wakeup(SLEEP_TIME);
  
  delay(100);
  
  // SpuÅ¡tÄ›nÃ­ deep sleep
  esp_deep_sleep_start();
}

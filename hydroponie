#include <WiFi.h>
#include <WebServer.h>
#include <ESPmDNS.h>
#include <NTPClient.h>
#include <WiFiUdp.h>
#include <Preferences.h>
#include <ArduinoJson.h>

// Konfigurace pin≈Ø
#define LED_PIN 3
#define PUMP_PIN 4
#define BUTTON1_PIN 0  // Override ƒçerpadlo
#define BUTTON2_PIN 1  // Override LED

// Osvƒõtlen√≠
#define LED_AUTOMAT_OSVETLENI_PIN 5  // zelen√° LED pro automat osvƒõtlen√≠
#define LED_MANUAL_OSVETLENI_PIN  6  // ≈ælut√° LED pro manu√°l osvƒõtlen√≠

// ƒåerpadlo
#define LED_AUTOMAT_CERPADLO_PIN  20  // zelen√° LED pro automat ƒçerpadlo
#define LED_MANUAL_CERPADLO_PIN   21  // ≈ælut√° LED pro manu√°l ƒçerpadlo

// WiFi nastaven√≠
struct WiFiNetwork {
  const char* ssid;
  const char* password;
};

WiFiNetwork wifiNetworks[] = {
  {"Kopretina", "SvataKaterina"},
  {"mostyMTS", "MikrotikPMT"}
};
const int numNetworks = 2;

// Webov√Ω server
WebServer server(80);

// NTP klient pro ƒças - NOV√â: dynamick√© nastaven√≠ ƒçasov√©ho p√°sma
WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP, "pool.ntp.org", 7200, 60000); // V√Ωchoz√≠ UTC+2

// Preferences pro ulo≈æen√≠ nastaven√≠
Preferences preferences;

// Glob√°ln√≠ promƒõnn√©
bool ledState = false;
bool pumpState = false;
int ledOverride = 0;   // -1=nucen√© vypnut√≠, 0=automatick√©, 1=nucen√© zapnut√≠
int pumpOverride = 0;  // -1=nucen√© vypnut√≠, 0=automatick√©, 1=nucen√© zapnut√≠
bool button1Pressed = false;
bool button2Pressed = false;
unsigned long lastButton1Press = 0;
unsigned long lastButton2Press = 0;
const unsigned long debounceDelay = 50;

// NOV√â: Nastaven√≠ ƒçasov√©ho p√°sma
bool isDaylightSaving = true;  // true = letn√≠ ƒças (UTC+2), false = zimn√≠ ƒças (UTC+1)

// ƒåasov√© nastaven√≠
struct TimeSchedule {
  int startHour;
  int startMinute;
  int endHour;
  int endMinute;
  bool enabled;
};

TimeSchedule ledSchedule = {8, 0, 20, 0, true};
int pumpInterval = 30;
int pumpDuration = 5;
unsigned long lastPumpCycle = 0;
unsigned long pumpStartTime = 0;
bool pumpEnabled = true;
bool pumpCycleActive = false;

void setup() {
  Serial.begin(115200);
  delay(2000);
  
  Serial.println("=== HYDROPONIE ESP32 START ===");
  
  // Inicializace pin≈Ø - rel√© jsou aktivn√≠ v LOW stavu
  pinMode(LED_PIN, OUTPUT);
  pinMode(PUMP_PIN, OUTPUT);
  pinMode(BUTTON1_PIN, INPUT_PULLUP);
  pinMode(BUTTON2_PIN, INPUT_PULLUP);
  
  // --- Inicializace nov√Ωch LED pin≈Ø ---
  pinMode(LED_AUTOMAT_OSVETLENI_PIN, OUTPUT);
  pinMode(LED_MANUAL_OSVETLENI_PIN, OUTPUT);
  pinMode(LED_AUTOMAT_CERPADLO_PIN, OUTPUT);
  pinMode(LED_MANUAL_CERPADLO_PIN, OUTPUT);
  
  // Vypnut√≠ v√Ωstup≈Ø na zaƒç√°tku (HIGH = rel√© vypnuto)
  digitalWrite(LED_PIN, HIGH);
  digitalWrite(PUMP_PIN, HIGH);
  Serial.println("Piny inicializov√°ny");

  // --- Zhasnout v≈°echny indik√°tory re≈æimu na startu ---
  digitalWrite(LED_AUTOMAT_OSVETLENI_PIN, LOW);
  digitalWrite(LED_MANUAL_OSVETLENI_PIN, LOW);
  digitalWrite(LED_AUTOMAT_CERPADLO_PIN, LOW);
  digitalWrite(LED_MANUAL_CERPADLO_PIN, LOW);
  
  // Naƒçten√≠ ulo≈æen√Ωch nastaven√≠
  loadSettings();
  Serial.println("Nastaven√≠ naƒçtena");
  
  // NOV√â: Nastaven√≠ ƒçasov√©ho p√°sma podle ulo≈æen√©ho nastaven√≠
  updateTimezone();
  
  // Pokus o p≈ôipojen√≠ k WiFi
  bool wifiConnected = connectToWiFi();
  
  if (wifiConnected) {
    Serial.println("WiFi √∫spƒõ≈°nƒõ p≈ôipojeno!");
    Serial.print("IP adresa: ");
    Serial.println(WiFi.localIP());
    Serial.print("S√≠≈•: ");
    Serial.println(WiFi.SSID());
    
    // Inicializace mDNS
    if (!MDNS.begin("hydroponie")) {
      Serial.println("Chyba p≈ôi spu≈°tƒõn√≠ mDNS");
    } else {
      Serial.println("mDNS spu≈°tƒõno: http://hydroponie.local");
    }
    
    // Inicializace NTP
    timeClient.begin();
    timeClient.update();
    Serial.println("NTP klient inicializov√°n");
    
  } else {
    Serial.println("NEPODA≈òILO SE P≈òIPOJIT K ≈Ω√ÅDN√â WIFI!");
    Serial.println("Spou≈°t√≠m AP m√≥d...");
    
    // Spustit AP m√≥d
    WiFi.softAP("Hydroponie-Setup", "123456789");
    Serial.print("AP spu≈°tƒõn - IP: ");
    Serial.println(WiFi.softAPIP());
    Serial.println("P≈ôipojte se k WiFi: Hydroponie-Setup");
    Serial.println("Heslo: 123456789");
  }
  
  // Nastaven√≠ webov√©ho serveru
  setupWebServer();
  
  server.begin();
  Serial.println("HTTP server spu≈°tƒõn");
  
  // Inicializace ƒçasovaƒçe ƒçerpadla
  lastPumpCycle = millis();
  pumpCycleActive = false;
  Serial.println("=== INICIALIZACE DOKONƒåENA ===");
}

void updateStatusLEDs() {
  // --- Osvƒõtlen√≠ ---
  if (ledOverride == 0) { // automat
    digitalWrite(LED_AUTOMAT_OSVETLENI_PIN, HIGH);   // zapnout zelenou LED
    digitalWrite(LED_MANUAL_OSVETLENI_PIN, LOW);     // zhasnout ≈ælutou LED
  } else { // manu√°l
    digitalWrite(LED_AUTOMAT_OSVETLENI_PIN, LOW);    // zhasnout zelenou LED
    digitalWrite(LED_MANUAL_OSVETLENI_PIN, HIGH);    // zapnout ≈ælutou LED
  }

  // --- ƒåerpadlo ---
  if (pumpOverride == 0) { // automat
    digitalWrite(LED_AUTOMAT_CERPADLO_PIN, HIGH);    // zapnout zelenou LED
    digitalWrite(LED_MANUAL_CERPADLO_PIN, LOW);      // zhasnout ≈ælutou LED
  } else { // manu√°l
    digitalWrite(LED_AUTOMAT_CERPADLO_PIN, LOW);     // zhasnout zelenou LED
    digitalWrite(LED_MANUAL_CERPADLO_PIN, HIGH);     // zapnout ≈ælutou LED
  }
}

// NOV√Å FUNKCE: Aktualizace ƒçasov√©ho p√°sma
void updateTimezone() {
  int offset = isDaylightSaving ? 7200 : 3600;  // UTC+2 nebo UTC+1
  timeClient.setTimeOffset(offset);
  Serial.printf("ƒåasov√© p√°smo nastaveno na: UTC%+d (%s ƒças)\n", 
                offset/3600, isDaylightSaving ? "letn√≠" : "zimn√≠");
}

bool connectToWiFi() {
  WiFi.mode(WIFI_STA);
  
  // Proj√≠t v≈°echny dostupn√© WiFi s√≠tƒõ
  Serial.println("Skenuji WiFi s√≠tƒõ...");
  int n = WiFi.scanNetworks();
  Serial.printf("Nalezeno %d WiFi s√≠t√≠\n", n);
  
  for (int i = 0; i < n; i++) {
    Serial.printf("%d: %s (%d dBm)\n", i + 1, WiFi.SSID(i).c_str(), WiFi.RSSI(i));
  }
  
  // Pokusit se p≈ôipojit k na≈°im zn√°m√Ωm s√≠t√≠m
  for (int netIndex = 0; netIndex < numNetworks; netIndex++) {
    String targetSSID = wifiNetworks[netIndex].ssid;
    
    // Zkontrolovat, jestli je na≈°e s√≠≈• dostupn√°
    bool networkFound = false;
    for (int i = 0; i < n; i++) {
      if (WiFi.SSID(i) == targetSSID) {
        networkFound = true;
        break;
      }
    }
    
    if (networkFound) {
      Serial.printf("Pokou≈°√≠m se p≈ôipojit k s√≠ti: %s\n", wifiNetworks[netIndex].ssid);
      WiFi.begin(wifiNetworks[netIndex].ssid, wifiNetworks[netIndex].password);
      
      // ƒåekat na p≈ôipojen√≠ (max 15 sekund)
      int attempts = 0;
      while (WiFi.status() != WL_CONNECTED && attempts < 30) {
        delay(500);
        Serial.print(".");
        attempts++;
      }
      Serial.println();
      
      if (WiFi.status() == WL_CONNECTED) {
        Serial.printf("√öspƒõ≈°nƒõ p≈ôipojeno k: %s\n", wifiNetworks[netIndex].ssid);
        return true;
      } else {
        Serial.printf("Nepoda≈ôilo se p≈ôipojit k: %s\n", wifiNetworks[netIndex].ssid);
        WiFi.disconnect();
        delay(1000);
      }
    } else {
      Serial.printf("S√≠≈• %s nen√≠ dostupn√°\n", wifiNetworks[netIndex].ssid);
    }
  }
  
  return false;
}

void loop() {
  server.handleClient();
  
  // Aktualizovat ƒças pouze pokud je WiFi p≈ôipojeno
  if (WiFi.status() == WL_CONNECTED) {
    timeClient.update();
  }
  
  handleButtons();
  controlDevices();
  updateStatusLEDs();
  delay(100);
}

void handleButtons() {
  unsigned long currentTime = millis();
  
  // Tlaƒç√≠tko 1 (pin 0) - Override ƒçerpadlo
  if (digitalRead(BUTTON1_PIN) == LOW && !button1Pressed) {
    if (currentTime - lastButton1Press > debounceDelay) {
      pumpOverride++;
      if (pumpOverride > 1) pumpOverride = -1; // Cyklus: 0 -> 1 -> -1 -> 0
      button1Pressed = true;
      lastButton1Press = currentTime;
      
      String overrideText = (pumpOverride == 1) ? "ZAPNUTO" : (pumpOverride == -1) ? "VYPNUTO" : "AUTO";
      Serial.printf("ƒåerpadlo Override: %s\n", overrideText.c_str());
    }
  } else if (digitalRead(BUTTON1_PIN) == HIGH) {
    button1Pressed = false;
  }
  
  // Tlaƒç√≠tko 2 (pin 1) - Override LED
  if (digitalRead(BUTTON2_PIN) == LOW && !button2Pressed) {
    if (currentTime - lastButton2Press > debounceDelay) {
      ledOverride++;
      if (ledOverride > 1) ledOverride = -1; // Cyklus: 0 -> 1 -> -1 -> 0
      button2Pressed = true;
      lastButton2Press = currentTime;
      
      String overrideText = (ledOverride == 1) ? "ZAPNUTO" : (ledOverride == -1) ? "VYPNUTO" : "AUTO";
      Serial.printf("LED Override: %s\n", overrideText.c_str());
    }
  } else if (digitalRead(BUTTON2_PIN) == HIGH) {
    button2Pressed = false;
  }
}

void controlDevices() {
  int currentHour = timeClient.getHours();
  int currentMinute = timeClient.getMinutes();
  int currentTimeMinutes = currentHour * 60 + currentMinute;
  
  // ≈ò√çZEN√ç LED - override m√° absolutn√≠ prioritu
  bool shouldLedBeOn = false;
  
  if (ledOverride == 1) {
    shouldLedBeOn = true;   // Nucen√© zapnut√≠
  } else if (ledOverride == -1) {
    shouldLedBeOn = false;  // Nucen√© vypnut√≠
  } else if (ledSchedule.enabled) {  // ledOverride == 0 = automatick√©
    int startTime = ledSchedule.startHour * 60 + ledSchedule.startMinute;
    int endTime = ledSchedule.endHour * 60 + ledSchedule.endMinute;
    
    if (startTime <= endTime) {
      shouldLedBeOn = (currentTimeMinutes >= startTime && currentTimeMinutes < endTime);
    } else {
      shouldLedBeOn = (currentTimeMinutes >= startTime || currentTimeMinutes < endTime);
    }
  }
  
  if (shouldLedBeOn != ledState) {
    ledState = shouldLedBeOn;
    digitalWrite(LED_PIN, ledState ? LOW : HIGH);
    Serial.printf("LED: %s\n", ledState ? "ZAPNUTO" : "VYPNUTO");
  }
  
  // ≈ò√çZEN√ç ƒåERPADLA - 3 stavy override + spr√°vn√© ƒçasov√°n√≠
  bool shouldPumpBeOn = false;
  unsigned long currentMillis = millis();
  
  if (pumpOverride == 1) {
    shouldPumpBeOn = true;  // Nucen√© zapnut√≠
    // P≈ôi override resetovat ƒçasovaƒçe
    if (!pumpState) {
      lastPumpCycle = currentMillis;
      pumpStartTime = currentMillis;
      pumpCycleActive = false;
    }
  } else if (pumpOverride == -1) {
    shouldPumpBeOn = false; // Nucen√© vypnut√≠
  } else if (pumpEnabled) { // pumpOverride == 0 = automatick√©
    
    // Zjistit stav cyklu
    unsigned long timeSinceLastCycle = currentMillis - lastPumpCycle;
    
    if (!pumpCycleActive) {
      // ƒåek√°me na start nov√©ho cyklu
      if (timeSinceLastCycle >= (pumpInterval * 60000UL)) {
        // ƒåas spustit ƒçerpadlo
        shouldPumpBeOn = true;
        pumpStartTime = currentMillis;
        pumpCycleActive = true;
        Serial.printf("DEBUG: Spou≈°t√≠m nov√Ω cyklus ƒçerpadla (ƒçekalo: %lu min)\n", timeSinceLastCycle / 60000UL);
      }
    } else {
      // Cyklus pr√°vƒõ bƒõ≈æ√≠
      unsigned long pumpRunTime = currentMillis - pumpStartTime;
      
      if (pumpRunTime < (pumpDuration * 60000UL)) {
        shouldPumpBeOn = true;  // Pokraƒçovat v bƒõhu
      } else {
        shouldPumpBeOn = false; // ƒåas vypnout a skonƒçit cyklus
        pumpCycleActive = false;
        lastPumpCycle = currentMillis;  // Reset pro dal≈°√≠ interval
        Serial.printf("DEBUG: ƒåerpadlo dokonƒçilo cyklus (bƒõ≈æelo: %lu s, nyn√≠ pauza %d min)\n", pumpRunTime / 1000, pumpInterval);
      }
    }
  }
  
  // Aplikovat zmƒõny stavu ƒçerpadla
  if (shouldPumpBeOn != pumpState) {
    pumpState = shouldPumpBeOn;
    digitalWrite(PUMP_PIN, pumpState ? LOW : HIGH);
    Serial.printf("ƒåerpadlo: %s\n", pumpState ? "ZAPNUTO" : "VYPNUTO");
  }
}

void setupWebServer() {
  // Hlavn√≠ str√°nka
  server.on("/", HTTP_GET, [](){
    server.send(200, "text/html", getIndexHTML());
  });
  
  // API pro z√≠sk√°n√≠ stavu
  server.on("/api/status", HTTP_GET, [](){
    StaticJsonDocument<1024> doc;
    
    if (WiFi.status() == WL_CONNECTED) {
      doc["time"] = timeClient.getFormattedTime();
    } else {
      doc["time"] = "Bez p≈ôipojen√≠";
    }
    
    doc["ledState"] = ledState;
    doc["pumpState"] = pumpState;
    doc["ledOverride"] = ledOverride;
    doc["pumpOverride"] = pumpOverride;
    doc["ledSchedule"]["startHour"] = ledSchedule.startHour;
    doc["ledSchedule"]["startMinute"] = ledSchedule.startMinute;
    doc["ledSchedule"]["endHour"] = ledSchedule.endHour;
    doc["ledSchedule"]["endMinute"] = ledSchedule.endMinute;
    doc["ledSchedule"]["enabled"] = ledSchedule.enabled;
    doc["pumpInterval"] = pumpInterval;
    doc["pumpDuration"] = pumpDuration;
    doc["pumpEnabled"] = pumpEnabled;
    doc["wifiConnected"] = (WiFi.status() == WL_CONNECTED);
    doc["wifiSSID"] = WiFi.SSID();
    doc["wifiRSSI"] = WiFi.RSSI();
    
    // NOV√â: P≈ôidat informace o ƒçasov√©m p√°smu
    doc["isDaylightSaving"] = isDaylightSaving;
    doc["timezoneOffset"] = isDaylightSaving ? 2 : 1;
    
    // P≈ôidat informace o ƒçase do spu≈°tƒõn√≠/zastaven√≠ ƒçerpadla
    if (pumpEnabled && pumpOverride == 0) {
      unsigned long currentMillis = millis();
      
      if (pumpCycleActive && pumpState) {
        // ƒåerpadlo bƒõ≈æ√≠ - zobrazit zb√Ωvaj√≠c√≠ ƒças
        unsigned long pumpRunTime = currentMillis - pumpStartTime;
        unsigned long timeUntilStop = (pumpDuration * 60000UL) - pumpRunTime;
        doc["pumpTimeRemaining"] = (int)(timeUntilStop / 1000);
        doc["pumpNextAction"] = "stop";
      } else if (!pumpCycleActive) {
        // ƒåerpadlo nebƒõ≈æ√≠ - zobrazit ƒças do spu≈°tƒõn√≠
        unsigned long timeSinceLastCycle = currentMillis - lastPumpCycle;
        unsigned long timeUntilNextPump = (pumpInterval * 60000UL) - timeSinceLastCycle;
        doc["pumpTimeRemaining"] = (int)(timeUntilNextPump / 1000);
        doc["pumpNextAction"] = "start";
      } else {
        doc["pumpTimeRemaining"] = 0;
        doc["pumpNextAction"] = "unknown";
      }
    } else {
      doc["pumpTimeRemaining"] = 0;
      doc["pumpNextAction"] = "manual";
    }
    
    String response;
    serializeJson(doc, response);
    server.send(200, "application/json", response);
  });
  
  server.on("/api/override", HTTP_POST, [](){
    if (server.hasArg("led")) {
      ledOverride = server.arg("led").toInt();
    }
    if (server.hasArg("pump")) {
      pumpOverride = server.arg("pump").toInt();
    }
    server.send(200, "application/json", "{\"status\":\"ok\"}");
  });
  
  server.on("/api/schedule", HTTP_POST, [](){
    if (server.hasArg("device")) {
      String device = server.arg("device");
      
      if (device == "led") {
        if (server.hasArg("startHour")) ledSchedule.startHour = server.arg("startHour").toInt();
        if (server.hasArg("startMinute")) ledSchedule.startMinute = server.arg("startMinute").toInt();
        if (server.hasArg("endHour")) ledSchedule.endHour = server.arg("endHour").toInt();
        if (server.hasArg("endMinute")) ledSchedule.endMinute = server.arg("endMinute").toInt();
        if (server.hasArg("enabled")) ledSchedule.enabled = server.arg("enabled") == "true";
      } else if (device == "pump") {
        if (server.hasArg("interval")) pumpInterval = server.arg("interval").toInt();
        if (server.hasArg("duration")) pumpDuration = server.arg("duration").toInt();
        if (server.hasArg("enabled")) pumpEnabled = server.arg("enabled") == "true";
      }
      
      saveSettings();
    }
    server.send(200, "application/json", "{\"status\":\"ok\"}");
  });

  // NOV√â API: Nastaven√≠ ƒçasov√©ho p√°sma
  server.on("/api/timezone", HTTP_POST, [](){
    if (server.hasArg("isDaylightSaving")) {
      isDaylightSaving = server.arg("isDaylightSaving") == "true";
      updateTimezone();
      saveSettings();
      Serial.printf("ƒåasov√© p√°smo zmƒõnƒõno na: %s ƒças\n", isDaylightSaving ? "letn√≠" : "zimn√≠");
    }
    server.send(200, "application/json", "{\"status\":\"ok\"}");
  });

  server.on("/api/restart", HTTP_POST, [](){
    server.send(200, "application/json", "{\"status\":\"restarting...\"}");
    delay(1000);
    ESP.restart();
  });
}

void loadSettings() {
  preferences.begin("hydroponie", false);
  
  ledSchedule.startHour = preferences.getInt("led_start_h", 8);
  ledSchedule.startMinute = preferences.getInt("led_start_m", 0);
  ledSchedule.endHour = preferences.getInt("led_end_h", 20);
  ledSchedule.endMinute = preferences.getInt("led_end_m", 0);
  ledSchedule.enabled = preferences.getBool("led_enabled", true);
  
  pumpInterval = preferences.getInt("pump_interval", 30);
  pumpDuration = preferences.getInt("pump_duration", 5);
  pumpEnabled = preferences.getBool("pump_enabled", true);
  
  // NOV√â: Naƒçten√≠ nastaven√≠ ƒçasov√©ho p√°sma
  isDaylightSaving = preferences.getBool("daylight_saving", true);
  
  preferences.end();
}

void saveSettings() {
  preferences.begin("hydroponie", false);
  
  preferences.putInt("led_start_h", ledSchedule.startHour);
  preferences.putInt("led_start_m", ledSchedule.startMinute);
  preferences.putInt("led_end_h", ledSchedule.endHour);
  preferences.putInt("led_end_m", ledSchedule.endMinute);
  preferences.putBool("led_enabled", ledSchedule.enabled);
  
  preferences.putInt("pump_interval", pumpInterval);
  preferences.putInt("pump_duration", pumpDuration);
  preferences.putBool("pump_enabled", pumpEnabled);
  
  // NOV√â: Ulo≈æen√≠ nastaven√≠ ƒçasov√©ho p√°sma
  preferences.putBool("daylight_saving", isDaylightSaving);
  
  preferences.end();
}

String getIndexHTML() {
  bool isAPMode = (WiFi.getMode() == WIFI_AP) || (WiFi.status() != WL_CONNECTED);
  
  String html = "<!DOCTYPE html>";
  html += "<html lang=\"cs\">";
  html += "<head>";
  html += "<meta charset=\"UTF-8\">";
  html += "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">";
  html += "<title>Hydroponie - Ovl√°d√°n√≠</title>";
  html += "<style>";
  
  // CSS stylov√°n√≠
  html += "body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; color: #333; }";
  html += ".container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0,2); overflow: hidden; }";
  html += ".header { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; padding: 30px 20px; text-align: center; }";
  html += ".header h1 { margin: 0; font-size: 2,5em; font-weight: 300; }";
  html += ".time-display { font-size: 1,5em; margin-top: 10px; opacity: 0,9; }";
  html += ".wifi-info { font-size: 0,9em; margin-top: 5px; opacity: 0,8; }";
  html += ".content { padding: 30px; }";
  html += ".section { margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #4CAF50; }";
  html += ".section h2 { margin-top: 0; color: #2c3e50; font-size: 1,3em; }";
  html += ".control-group { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px; }";
  html += ".control-group label { font-weight: 500; min-width: 100px; }";
  html += ".control-group input { padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; }";
  html += ".control-group input:focus { outline: none; border-color: #4CAF50; }";
  html += ".button { background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0,3s ease; margin: 5px; }";
  html += ".button:hover { background: #45a049; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0,4); }";
  html += ".button.force-on { background: #ff6b6b; }";
  html += ".button.force-on:hover { background: #ff5252; }";
  html += ".button.force-off { background: #757575; }";
  html += ".button.force-off:hover { background: #616161; }";
  html += ".button.warning { background: #ff9800; }";
  html += ".button.warning:hover { background: #e68900; }";
  html += ".status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: 500; margin-left: 10px; }";
  html += ".status.on { background: #d4edda; color: #155724; }";
  html += ".status.off { background: #f8d7da; color: #721c24; }";
  html += ".time-input { display: flex; gap: 5px; align-items: center; }";
  html += ".time-input input { width: 60px; }";
  html += ".device-status { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }";
  html += ".ap-mode-warning { background: #fff3cd; border: 2px solid #ffeaa7; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center; }";
  html += ".pump-timer { font-size: 0,9em; color: #666; margin-left: 10px; }";
  html += ".editing { background: #fff9c4 !important; border: 2px solid #f39c12 !important; }";
  html += ".timezone-info { font-size: 0,8em; color: #666; margin-top: 5px; }";
  html += ".timezone-toggle { background: #17a2b8; }";
  html += ".timezone-toggle:hover { background: #138496; }";
  html += "@media (max-width: 600px) { .control-group { flex-direction: column; align-items: stretch; } .control-group label { min-width: auto; } }";
  
  html += "</style></head>";
  
  html += "<body>";
  html += "<div class=\"container\">";
  html += "<div class=\"header\">";
  html += "<h1>üå± Hydroponie</h1>";
  html += "<div class=\"time-display\" id=\"currentTime\">--:--:--</div>";
  html += "<div class=\"timezone-info\" id=\"timezoneInfo\">Naƒç√≠t√°m ƒçasov√© p√°smo...</div>";
  html += "<div class=\"wifi-info\" id=\"wifiInfo\">Naƒç√≠t√°m...</div>";
  html += "</div>";
  
  html += "<div class=\"content\">";

  if (isAPMode) {
    html += "<div class=\"ap-mode-warning\">";
    html += "<h2>‚ö†Ô∏è Konfiguraƒçn√≠ m√≥d</h2>";
    html += "<p>ESP32 se nepoda≈ôilo p≈ôipojit k ≈æ√°dn√© zn√°m√© WiFi s√≠ti.<br>";
    html += "P≈ôipojili jste se k AP m√≥du. Nƒõkter√© funkce mohou b√Ωt omezen√©.</p>";
    html += "<button class=\"button warning\" onclick=\"restartDevice()\">üîÑ Restart za≈ô√≠zen√≠</button>";
    html += "</div>";
  }
  
  // NOV√Å SEKCE: Nastaven√≠ ƒçasu
  html += "<div class=\"section\">";
  html += "<h2>‚è∞ Nastaven√≠ ƒçasu</h2>";
  html += "<div class=\"device-status\">";
  html += "<div>ƒåasov√© p√°smo: <span id=\"timezoneDisplay\">Naƒç√≠t√°m...</span></div>";
  html += "<button class=\"button timezone-toggle\" id=\"timezoneButton\" onclick=\"toggleTimezone()\">P≈ôepnout na zimn√≠ ƒças</button>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class=\"section\">";
  html += "<h2>üìä Aktu√°ln√≠ stav</h2>";
  html += "<div class=\"device-status\">";
  html += "<div>üí° LED p√°sek: <span class=\"status off\" id=\"ledStatus\">VYPNUTO</span></div>";
  html += "<button class=\"button\" id=\"ledOverride\" onclick=\"toggleOverride('led')\">Auto LED</button>";
  html += "</div>";
  html += "<div class=\"device-status\">";
  html += "<div>üíß ƒåerpadlo: <span class=\"status off\" id=\"pumpStatus\">VYPNUTO</span><span class=\"pump-timer\" id=\"pumpTimer\"></span></div>";
  html += "<button class=\"button\" id=\"pumpOverride\" onclick=\"toggleOverride('pump')\">Auto ƒçerpadlo</button>";
  html += "</div>";
  html += "</div>";
  
  html += "<div class=\"section\">";
  html += "<h2>üí° Nastaven√≠ LED p√°sku</h2>";
  html += "<div class=\"control-group\">";
  html += "<label>Zapnout:</label>";
  html += "<div class=\"time-input\">";
  html += "<input type=\"number\" id=\"ledStartHour\" min=\"0\" max=\"23\" value=\"8\" onchange=\"markEditing(this)\" onfocus=\"markEditing(this)\">";
  html += "<span>:</span>";
  html += "<input type=\"number\" id=\"ledStartMinute\" min=\"0\" max=\"59\" value=\"0\" onchange=\"markEditing(this)\" onfocus=\"markEditing(this)\">";
  html += "</div></div>";
  html += "<div class=\"control-group\">";
  html += "<label>Vypnout:</label>";
  html += "<div class=\"time-input\">";
  html += "<input type=\"number\" id=\"ledEndHour\" min=\"0\" max=\"23\" value=\"20\" onchange=\"markEditing(this)\" onfocus=\"markEditing(this)\">";
  html += "<span>:</span>";
  html += "<input type=\"number\" id=\"ledEndMinute\" min=\"0\" max=\"59\" value=\"0\" onchange=\"markEditing(this)\" onfocus=\"markEditing(this)\">";
  html += "</div></div>";
  html += "<div class=\"control-group\">";
  html += "<label><input type=\"checkbox\" id=\"ledEnabled\" checked onchange=\"markEditing(this)\"> Automatick√© ovl√°d√°n√≠ zapnuto</label>";
  html += "</div>";
  html += "<button class=\"button\" onclick=\"saveLedSchedule()\">üíæ Ulo≈æit nastaven√≠ LED</button>";
  html += "</div>";
  
  html += "<div class=\"section\">";
  html += "<h2>üíß Nastaven√≠ ƒçerpadla</h2>";
  html += "<div class=\"control-group\">";
  html += "<label>Interval mezi spu≈°tƒõn√≠m (minuty):</label>";
  html += "<input type=\"number\" id=\"pumpInterval\" min=\"1\" max=\"1440\" value=\"30\" onchange=\"markEditing(this)\" onfocus=\"markEditing(this)\">";
  html += "</div>";
  html += "<div class=\"control-group\">";
  html += "<label>Doba bƒõhu (minuty):</label>";
  html += "<input type=\"number\" id=\"pumpDuration\" min=\"1\" max=\"60\" value=\"5\" onchange=\"markEditing(this)\" onfocus=\"markEditing(this)\">";
  html += "</div>";
  html += "<div class=\"control-group\">";
  html += "<label><input type=\"checkbox\" id=\"pumpEnabled\" checked onchange=\"markEditing(this)\"> Automatick√© ovl√°d√°n√≠ zapnuto</label>";
  html += "</div>";
  html += "<button class=\"button\" onclick=\"savePumpSchedule()\">üíæ Ulo≈æit nastaven√≠ ƒçerpadla</button>";
  html += "</div>";
  
  html += "</div></div>";
  
  html += "<script>";
  html += "let currentStatus = {};";
  html += "let isEditing = false;";
  html += "let updateInterval;";
  html += "window.onload = function() { startUpdating(); };";
  
  html += "function startUpdating() {";
  html += "updateStatus();";
  html += "updateInterval = setInterval(function() { if (!isEditing) updateStatus(); }, 2000);";
  html += "}";
  
  html += "function markEditing(element) {";
  html += "isEditing = true;";
  html += "element.classList.add('editing');";
  html += "setTimeout(function() { isEditing = false; element.classList.remove('editing'); }, 5000);";
  html += "}";
  
  html += "function formatTime(seconds) {";
  html += "if (seconds <= 0) return '';";
  html += "const mins = Math.floor(seconds / 60);";
  html += "const secs = seconds % 60;";
  html += "if (mins > 0) return `${mins}m ${secs}s`;";
  html += "return `${secs}s`;";
  html += "}";
  
  html += "function updateStatus() {";
  html += "fetch('/api/status').then(response => response.json()).then(data => {";
  html += "currentStatus = data;";
  html += "document.getElementById('currentTime').textContent = data.time;";
  
  // NOV√â: Aktualizace informac√≠ o ƒçasov√©m p√°smu
  html += "const timezoneDisplay = document.getElementById('timezoneDisplay');";
  html += "const timezoneButton = document.getElementById('timezoneButton');";
  html += "const timezoneInfo = document.getElementById('timezoneInfo');";
  html += "if (data.isDaylightSaving) {";
  html += "timezoneDisplay.textContent = 'Letn√≠ ƒças (UTC+2)';";
  html += "timezoneButton.textContent = '‚ùÑÔ∏è P≈ôepnout na zimn√≠ ƒças';";
  html += "timezoneInfo.textContent = 'üåû Letn√≠ ƒças (UTC+2)';";
  html += "} else {";
  html += "timezoneDisplay.textContent = 'Zimn√≠ ƒças (UTC+1)';";
  html += "timezoneButton.textContent = '‚òÄÔ∏è P≈ôepnout na letn√≠ ƒças';";
  html += "timezoneInfo.textContent = '‚ùÑÔ∏è Zimn√≠ ƒças (UTC+1)';";
  html += "}";
  
  html += "if (data.wifiConnected) {";
  html += "document.getElementById('wifiInfo').innerHTML = 'üì∂ ' + data.wifiSSID + ' (' + data.wifiRSSI + ' dBm)';";
  html += "} else {";
  html += "document.getElementById('wifiInfo').innerHTML = 'üì∂ Nen√≠ p≈ôipojeno k WiFi';";
  html += "}";
  html += "updateDeviceStatus('led', data.ledState, data.ledOverride);";
  html += "updateDeviceStatus('pump', data.pumpState, data.pumpOverride);";
  
  // Aktualizovat ƒçasovaƒç ƒçerpadla
  html += "const pumpTimer = document.getElementById('pumpTimer');";
  html += "if (data.pumpTimeRemaining > 0 && data.pumpNextAction !== 'manual') {";
  html += "const timeStr = formatTime(data.pumpTimeRemaining);";
  html += "if (data.pumpNextAction === 'stop') {";
  html += "pumpTimer.textContent = ' - zastav√≠ za ' + timeStr;";
  html += "} else {";
  html += "pumpTimer.textContent = ' - spust√≠ za ' + timeStr;";
  html += "}";
  html += "} else {";
  html += "pumpTimer.textContent = '';";
  html += "}";
  
  html += "if (!isEditing) loadFormData(data);";
  html += "}).catch(error => console.error('Chyba p≈ôi naƒç√≠t√°n√≠ stavu:', error));";
  html += "}";
  
  html += "function updateDeviceStatus(device, state, override) {";
  html += "const statusElement = document.getElementById(device + 'Status');";
  html += "const overrideButton = document.getElementById(device + 'Override');";
  html += "if (state) { statusElement.textContent = 'ZAPNUTO'; statusElement.className = 'status on'; }";
  html += "else { statusElement.textContent = 'VYPNUTO'; statusElement.className = 'status off'; }";
  
  html += "overrideButton.classList.remove('force-on', 'force-off');";
  html += "if (override === 1) { overrideButton.textContent = 'Nucen√© ZAP'; overrideButton.classList.add('force-on'); }";
  html += "else if (override === -1) { overrideButton.textContent = 'Nucen√© VYP'; overrideButton.classList.add('force-off'); }";
  html += "else { overrideButton.textContent = 'Auto ' + (device === 'led' ? 'LED' : 'ƒçerpadlo'); }";
  html += "}";
  
  html += "function loadFormData(data) {";
  html += "const inputs = ['ledStartHour', 'ledStartMinute', 'ledEndHour', 'ledEndMinute', 'ledEnabled', 'pumpInterval', 'pumpDuration', 'pumpEnabled'];";
  html += "inputs.forEach(id => {";
  html += "const element = document.getElementById(id);";
  html += "if (element && !element.classList.contains('editing')) {";
  html += "if (element.type === 'checkbox') {";
  html += "if (id === 'ledEnabled') element.checked = data.ledSchedule.enabled;";
  html += "else if (id === 'pumpEnabled') element.checked = data.pumpEnabled;";
  html += "} else {";
  html += "if (id.startsWith('led')) {";
  html += "const key = id.replace('led', '').toLowerCase();";
  html += "if (key === 'starthour') element.value = data.ledSchedule.startHour;";
  html += "else if (key === 'startminute') element.value = data.ledSchedule.startMinute;";
  html += "else if (key === 'endhour') element.value = data.ledSchedule.endHour;";
  html += "else if (key === 'endminute') element.value = data.ledSchedule.endMinute;";
  html += "} else if (id === 'pumpInterval') element.value = data.pumpInterval;";
  html += "else if (id === 'pumpDuration') element.value = data.pumpDuration;";
  html += "}";
  html += "}";
  html += "});";
  html += "}";
  
  // NOV√Å FUNKCE: P≈ôep√≠n√°n√≠ ƒçasov√©ho p√°sma
  html += "function toggleTimezone() {";
  html += "const newDST = !currentStatus.isDaylightSaving;";
  html += "const formData = new FormData();";
  html += "formData.append('isDaylightSaving', newDST);";
  html += "fetch('/api/timezone', { method: 'POST', body: formData })";
  html += ".then(response => response.json()).then(data => { console.log('ƒåasov√© p√°smo zmƒõnƒõno:', data); updateStatus(); })";
  html += ".catch(error => console.error('Chyba p≈ôi zmƒõnƒõ ƒçasov√©ho p√°sma:', error));";
  html += "}";
  
  html += "function toggleOverride(device) {";
  html += "const currentOverride = device === 'led' ? currentStatus.ledOverride : currentStatus.pumpOverride;";
  html += "let newState = currentOverride + 1;";
  html += "if (newState > 1) newState = -1;";
  html += "const formData = new FormData();";
  html += "formData.append(device, newState);";
  html += "fetch('/api/override', { method: 'POST', body: formData })";
  html += ".then(response => response.json()).then(data => { console.log('Override zmƒõnƒõn:', data); updateStatus(); })";
  html += ".catch(error => console.error('Chyba p≈ôi zmƒõnƒõ override:', error));";
  html += "}";
  
  html += "function saveLedSchedule() {";
  html += "const formData = new FormData();";
  html += "formData.append('device', 'led');";
  html += "formData.append('startHour', document.getElementById('ledStartHour').value);";
  html += "formData.append('startMinute', document.getElementById('ledStartMinute').value);";
  html += "formData.append('endHour', document.getElementById('ledEndHour').value);";
  html += "formData.append('endMinute', document.getElementById('ledEndMinute').value);";
  html += "formData.append('enabled', document.getElementById('ledEnabled').checked);";
  html += "fetch('/api/schedule', { method: 'POST', body: formData })";
  html += ".then(response => response.json()).then(data => { alert('Nastaven√≠ LED ulo≈æeno!'); isEditing = false; updateStatus(); })";
  html += ".catch(error => { console.error('Chyba p≈ôi ukl√°d√°n√≠:', error); alert('Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠!'); });";
  html += "}";
  
  html += "function savePumpSchedule() {";
  html += "const formData = new FormData();";
  html += "formData.append('device', 'pump');";
  html += "formData.append('interval', document.getElementById('pumpInterval').value);";
  html += "formData.append('duration', document.getElementById('pumpDuration').value);";
  html += "formData.append('enabled', document.getElementById('pumpEnabled').checked);";
  html += "fetch('/api/schedule', { method: 'POST', body: formData })";
  html += ".then(response => response.json()).then(data => { alert('Nastaven√≠ ƒçerpadla ulo≈æeno!'); isEditing = false; updateStatus(); })";
  html += ".catch(error => { console.error('Chyba p≈ôi ukl√°d√°n√≠:', error); alert('Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠!'); });";
  html += "}";

  html += "function restartDevice() {";
  html += "if (confirm('Opravdu chcete restartovat za≈ô√≠zen√≠?')) {";
  html += "fetch('/api/restart', { method: 'POST' })";
  html += ".then(response => response.json()).then(data => { alert('Za≈ô√≠zen√≠ se restartuje...'); })";
  html += ".catch(error => console.error('Chyba p≈ôi restartu:', error));";
  html += "}";
  html += "}";
  
  html += "</script>";
  html += "</body></html>";
  
  return html;
}
